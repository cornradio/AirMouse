<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Macro Deck | Âø´Êç∑ÊåâÈîÆÈù¢Êùø</title>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
            outline: none;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background: #111;
            border-bottom: 1px solid #222;
        }

        .back-btn {
            font-size: 14px;
            color: #888;
            padding: 5px 10px;
        }

        .profile-selector {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #profile-select {
            background: #111;
            border: 1px solid #333;
            color: #007AFF;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            max-width: 130px;
            font-size: 14px;
        }

        .profile-ops {
            color: #555;
            font-size: 22px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fs-btn,
        .edit-toggle {
            font-size: 13px;
            color: #888;
            padding: 5px 8px;
        }

        .edit-toggle {
            color: #007AFF;
        }

        /* ÊåâÈíÆÁΩëÊ†º */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(var(--cols, 4), 1fr);
            gap: 10px;
            padding: 15px;
            flex: 1.2;
            min-height: 0;
            overflow-y: auto;
        }

        .macro-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s, background 0.2s;
        }

        .macro-btn:active {
            transform: scale(0.95);
            background: #333;
        }

        .macro-btn.editing::after {
            content: "‚öôÔ∏è";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            padding: 2px;
        }

        .macro-btn .emoji {
            font-size: 32px;
            margin-bottom: 2px;
            pointer-events: none;
        }

        .macro-btn .label {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            padding: 0 4px;
            pointer-events: none;
        }

        /* ÊãñÊãΩÂç†‰ΩçÁ¨¶ */
        .sortable-ghost {
            opacity: 0.3;
            background: #007AFF !important;
        }

        /* Ëß¶Êë∏Êùø */
        #pad-area {
            flex: 1;
            margin: 10px 15px 20px;
            background: #080808;
            border: 2px dashed #1a1a1a;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #222;
            font-weight: bold;
            letter-spacing: 5px;
            font-size: 12px;
        }

        /* ÂºπÁ™óÈÄöÁî®Ê†∑Âºè */
        .modal-outer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            width: 85%;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #007AFF;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            text-align: center;
        }

        .btn-save {
            background: #007AFF;
            color: #fff;
        }

        .btn-cancel {
            background: #333;
            color: #eee;
        }

        .btn-delete {
            background: #FF3B30;
            color: #fff;
        }
    </style>
</head>

<body onclick="initAudio()">
    <div class="header">
        <div class="back-btn" onclick="v(); window.location.href='/'">BACK</div>
        <div class="profile-selector">
            <select id="profile-select" onchange="v(); switchProfile(this.value)"></select>
            <div class="profile-ops" onclick="v(); addProfile()">+</div>
            <div class="profile-ops" style="font-size: 16px; margin-left: -5px;" onclick="v(); showProfileConfig()">‚öôÔ∏è
            </div>
        </div>
        <div class="fs-btn" onclick="v(); toggleFullScreen()">FULL</div>
        <div class="edit-toggle" onclick="toggleEditMode()">EDIT</div>
    </div>

    <!-- ÊåâÈíÆÂå∫ -->
    <div id="btn-grid" class="btn-grid"></div>

    <!-- Ëß¶ÊéßÊùøÂå∫ -->
    <div id="pad-area">TOUCHPAD</div>

    <!-- 1. ÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü (Profile Settings) -->
    <div id="profile-modal" class="modal-outer">
        <div class="modal-content">
            <h3>Profile Config</h3>
            <div class="input-group">
                <label>Grid Columns (3, 4, 5)</label>
                <select id="cfg-grid-size">
                    <option value="3">3 x 3</option>
                    <option value="4">4 x 4</option>
                    <option value="5">5 x 5</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeProfileConfig()">Cancel</button>
                <button class="modal-btn btn-delete" onclick="deleteCurrentProfile()">Delete</button>
                <button class="modal-btn btn-save" onclick="saveProfileConfig()">Save</button>
            </div>
        </div>
    </div>

    <!-- 2. ÊåâÈîÆÈÖçÁΩÆÂºπÁ™ó (Button Settings) -->
    <div id="btn-modal" class="modal-outer">
        <div class="modal-content">
            <h3>Button Config</h3>
            <div class="input-group">
                <label>Label / Name</label>
                <input type="text" id="cfg-label" placeholder="e.g. Copy">
            </div>
            <div class="input-group">
                <label>
                    Emoji Icon
                    <a href="https://emojidb.org/" target="_blank" style="color: #007AFF; text-decoration: none;">Emoji
                        DB ‚Üó</a>
                </label>
                <input type="text" id="cfg-emoji" placeholder="e.g. üöÄ">
            </div>
            <div class="input-group">
                <label>
                    Keys (comma separated)
                    <a href="https://pynput.readthedocs.io/en/latest/keyboard.html#pynput.keyboard.Key" target="_blank"
                        style="color: #007AFF; text-decoration: none;">Doc ‚Üó</a>
                </label>
                <input type="text" id="cfg-keys" placeholder="ctrl,c">
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeBtnConfig()">Cancel</button>
                <button class="modal-btn btn-save" onclick="saveBtnConfig()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/dist/sortable.full.js"></script>
    <script src="/static/js/touchpad.js"></script>
    <script>
        const socket = io();
        let audioCtx = null;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        const v = () => { if (navigator.vibrate) navigator.vibrate(25); };

        let editMode = false;
        let currentEditIndex = -1;
        let currentProfile = "Default";
        let sortable = null;

        let macroData = {
            current: "Default",
            profiles: {
                "Default": {
                    cols: 4,
                    buttons: Array(16).fill(null).map(() => ({ label: "", emoji: "", keys: "" }))
                }
            }
        };

        // --- Êï∞ÊçÆÂä†ËΩΩ‰∏éÂêåÊ≠• ---
        socket.emit('load_macros');
        socket.on('macros_loaded', (data) => {
            if (data && data.profiles) {
                macroData = data;
                // Êï∞ÊçÆÁªìÊûÑËøÅÁßª/Ë°•ÂÖ®
                Object.keys(macroData.profiles).forEach(name => {
                    if (Array.isArray(macroData.profiles[name])) {
                        const btns = macroData.profiles[name];
                        macroData.profiles[name] = { cols: 4, buttons: btns };
                    }
                });
                currentProfile = macroData.current || Object.keys(macroData.profiles)[0] || "Default";
            }
            updateProfileUI();
            renderButtons();
        });

        function saveToServer() {
            socket.emit('save_macros', macroData);
        }

        // --- ÈÖçÁΩÆÁÆ°ÁêÜ ---
        function updateProfileUI() {
            const select = document.getElementById('profile-select');
            select.innerHTML = '';
            Object.keys(macroData.profiles).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                if (name === currentProfile) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function switchProfile(name) {
            currentProfile = name;
            macroData.current = name;
            saveToServer();
            renderButtons();
        }

        function addProfile() {
            const name = prompt("Enter Profile Name:");
            if (name && !macroData.profiles[name]) {
                macroData.profiles[name] = {
                    cols: 4,
                    buttons: Array(16).fill(null).map(() => ({ label: "", emoji: "", keys: "" }))
                };
                currentProfile = name;
                macroData.current = name;
                updateProfileUI();
                saveToServer();
                renderButtons();
            }
        }

        function showProfileConfig() {
            const profile = macroData.profiles[currentProfile];
            document.getElementById('cfg-grid-size').value = profile.cols || 4;
            document.getElementById('profile-modal').style.display = 'flex';
        }

        function closeProfileConfig() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        function deleteCurrentProfile() {
            if (Object.keys(macroData.profiles).length <= 1) {
                alert("Cannot delete last profile.");
                return;
            }
            if (confirm(`Delete profile "${currentProfile}"?`)) {
                delete macroData.profiles[currentProfile];
                currentProfile = Object.keys(macroData.profiles)[0];
                macroData.current = currentProfile;
                updateProfileUI();
                saveToServer();
                closeProfileConfig();
                renderButtons();
            }
        }

        function saveProfileConfig() {
            const newCols = parseInt(document.getElementById('cfg-grid-size').value);
            const profile = macroData.profiles[currentProfile];
            const target = newCols * newCols;

            // Â¶ÇÊûúÊñ∞Ê†ºÂ≠êÊõ¥Â∞ëÔºåÊèêÁ§∫Áî®Êà∑
            if (profile.buttons.length > target) {
                if (!confirm(`Switching to ${newCols}x${newCols} will remove ${profile.buttons.length - target} extra buttons. Continue?`)) {
                    return;
                }
            }

            profile.cols = newCols;

            // Ë°•ÂÖ®ÊàñÊà™Êñ≠Ê†ºÂ≠ê
            if (profile.buttons.length < target) {
                while (profile.buttons.length < target) {
                    profile.buttons.push({ label: "", emoji: "", keys: "" });
                }
            } else if (profile.buttons.length > target) {
                profile.buttons = profile.buttons.slice(0, target);
            }

            saveToServer();
            closeProfileConfig();
            renderButtons();
        }

        // --- ÊåâÈíÆÊ∏≤Êüì‰∏éÊéíÂ∫è ---
        function renderButtons() {
            const grid = document.getElementById('btn-grid');
            grid.innerHTML = '';
            const profile = macroData.profiles[currentProfile];
            grid.style.setProperty('--cols', profile.cols);

            profile.buttons.forEach((cfg, i) => {
                const btn = document.createElement('div');
                btn.className = 'macro-btn' + (editMode ? ' editing' : '');

                if (cfg.emoji) {
                    const em = document.createElement('div');
                    em.className = 'emoji';
                    em.innerText = cfg.emoji;
                    btn.appendChild(em);
                }

                if (cfg.label) {
                    const label = document.createElement('div');
                    label.className = 'label';
                    label.innerText = cfg.label;
                    btn.appendChild(label);
                }

                btn.onpointerdown = (e) => handleBtnDown(i, e);
                btn.onpointerup = (e) => handleBtnUp(i, e);
                btn.onpointercancel = (e) => handleBtnUp(i, e);
                btn.onclick = (e) => {
                    if (editMode) {
                        v();
                        openBtnConfig(i);
                    }
                };
                grid.appendChild(btn);
            });

            initSortable();
        }

        function initSortable() {
            if (sortable) sortable.destroy();
            const grid = document.getElementById('btn-grid');
            sortable = Sortable.create(grid, {
                disabled: !editMode,
                animation: 150,
                swap: true, // ÂºÄÂêØ‰∫§Êç¢Ê®°Âºè
                swapClass: 'sortable-swap-highlight',
                ghostClass: 'sortable-ghost',
                delay: 100, // Â¢ûÂä†Âª∂ËøüÔºåÈò≤Ê≠¢ËØØËß¶ÂèëÁÇπÂáª
                delayOnTouchOnly: true,
                onEnd: (evt) => {
                    const buttons = macroData.profiles[currentProfile].buttons;
                    // Áõ¥Êé•‰∫§Êç¢‰∏§‰∏™‰ΩçÁΩÆÁöÑÊï∞ÊçÆÔºå‰∏çÁßªÂä®ÂÖ∂‰ªñÊåâÈîÆ
                    const temp = buttons[evt.oldIndex];
                    buttons[evt.oldIndex] = buttons[evt.newIndex];
                    buttons[evt.newIndex] = temp;

                    saveToServer();
                    renderButtons();
                }
            });
        }

        function toggleEditMode() {
            v();
            editMode = !editMode;
            document.querySelector('.edit-toggle').innerText = editMode ? 'DONE' : 'EDIT';
            renderButtons();
        }

        // --- ÊåâÈîÆÊâßË°å‰∏éËÆæÁΩÆ ---
        function handleBtnDown(i, e) {
            if (editMode) return;
            v();
            const cfg = macroData.profiles[currentProfile].buttons[i];
            if (cfg && cfg.keys) {
                const keys = cfg.keys.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                keys.forEach(k => {
                    socket.emit('key_action', { key: k, action: 'down' });
                });
            }
        }

        function handleBtnUp(i, e) {
            if (editMode) return;
            const cfg = macroData.profiles[currentProfile].buttons[i];
            if (cfg && cfg.keys) {
                const keys = cfg.keys.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                // ÈÄÜÂ∫èÈáäÊîæÔºåÁ°Æ‰øùÂ¶Ç ctrl+c ÊòØÂÖàÊùæÂºÄ c ÂÜçÊùæÂºÄ ctrl
                [...keys].reverse().forEach(k => {
                    socket.emit('key_action', { key: k, action: 'up' });
                });
            }
        }

        function openBtnConfig(i) {
            currentEditIndex = i;
            const cfg = macroData.profiles[currentProfile].buttons[i];
            document.getElementById('cfg-label').value = cfg.label || '';
            document.getElementById('cfg-emoji').value = cfg.emoji || '';
            document.getElementById('cfg-keys').value = cfg.keys || '';
            document.getElementById('btn-modal').style.display = 'flex';
        }

        function closeBtnConfig() {
            document.getElementById('btn-modal').style.display = 'none';
        }

        function saveBtnConfig() {
            macroData.profiles[currentProfile].buttons[currentEditIndex] = {
                label: document.getElementById('cfg-label').value.trim(),
                emoji: document.getElementById('cfg-emoji').value.trim(),
                keys: document.getElementById('cfg-keys').value.trim()
            };
            saveToServer();
            closeBtnConfig();
            renderButtons();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // Ëß¶ÁõÆÊùø
        const touchpad = new TouchpadModule('pad-area', socket, {
            getSensitivity: () => parseFloat(localStorage.getItem('mouse_sense')) || 4.0,
            feedback: v
        });

    </script>
</body>

</html>