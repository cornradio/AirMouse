<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Macro Deck | Âø´Êç∑ÊåâÈîÆÈù¢Êùø</title>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            background: #111;
            border-bottom: 1px solid #222;
            gap: 5px;
        }

        .header-btn {
            font-size: 13px;
            color: #888;
            padding: 8px 6px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }

        .header-btn.active {
            color: #007AFF !important;
        }

        .profile-selector {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        #profile-select {
            background: #111;
            border: 1px solid #333;
            color: #007AFF;
            font-weight: bold;
            padding: 4px 6px;
            border-radius: 6px;
            max-width: 90px;
            font-size: 12px;
        }

        /* ÊåâÈíÆÁΩëÊ†º */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(var(--cols, 4), 1fr);
            gap: 10px;
            padding: 15px;
            flex: 1.2;
            min-height: 0;
            overflow-y: auto;
            /* ‰øùËØÅÂÆΩÂ±è‰ΩìÈ™å */
            max-width: 540px;
            margin: auto;
        }

        .macro-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
            touch-action: manipulation;
        }

        .macro-btn.sorting {
            touch-action: none;
            border: 1px dashed #007AFF;
            opacity: 0.8;
            cursor: move;
        }

        .macro-btn.editing::after {
            content: "‚öôÔ∏è";
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            opacity: 0.6;
        }

        .macro-btn:active {
            transform: scale(0.96);
            background: #252525;
        }

        .macro-btn .emoji {
            font-size: 32px;
            margin-bottom: 2px;
            pointer-events: none;
        }

        .macro-btn .label {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            padding: 0 4px;
            pointer-events: none;
        }

        /* Sortable Styles */
        .sortable-ghost {
            opacity: 0.4;
            background: #333 !important;
        }

        .sortable-swap-highlight {
            background: #007AFF !important;
            border: 2px solid #fff !important;
            z-index: 10;
        }

        #pad-area {
            flex: 1;
            margin: 10px 15px 20px;
            background: #080808;
            border: 2px dashed #1a1a1a;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #222;
            font-weight: bold;
            font-size: 12px;
            letter-spacing: 5px;
        }

        /* ‰∏ªÂ∏ÉÂ±ÄÂÆπÂô® */
        .main-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .modal-outer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .modal-content h3 {
            margin: 0;
            color: #007AFF;
            font-size: 16px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-delete-btn {
            color: #FF3B30;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-save {
            background: #007AFF;
            color: #fff;
        }

        .btn-cancel {
            background: #333;
            color: #eee;
        }

        .btn-delete {
            background: #FF3B30;
            color: #fff;
        }

        /* Ê®™Â±èÈÄÇÈÖçÔºöÂ∑¶Âè≥Âπ∂Êéí */
        @media (orientation: portrait) {
            .btn-grid {
                max-height: 48%;
            }
        }

        @media (orientation: landscape) {
            .main-layout {
                flex-direction: row;
            }

            #pad-area {
                display: flex;
                margin: 10px 15px 10px 5px;
                flex: 1;
            }

            .btn-grid {
                max-width: 42%;
                margin: 0;
                flex: 1.5;
                /* ÊåâÈíÆÂå∫Âç†Â§ßÂ§¥ */
                padding: 10px;
            }

            .header {
                height: 40px;
                padding: 0 5px;
            }

            .header-btn {
                padding: 4px 6px;
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-btn" onclick="v(); window.location.href='/'">BACK</div>
        <div class="profile-selector">
            <select id="profile-select" onchange="v(); switchProfile(this.value)"></select>
            <div class="header-btn" style="color:#666" onclick="v(); addProfile()">‚ûï</div>
            <div class="header-btn" style="color:#666" onclick="v(); showProfileConfig()">‚öôÔ∏è</div>
        </div>
        <div class="header-btn" onclick="v(); toggleFullScreen()">‚õ∂</div>
        <div id="sort-toggle" class="header-btn" onclick="toggleSortMode()">MOVE</div>
        <div id="edit-toggle" class="header-btn" onclick="toggleEditMode()">EDIT</div>
    </div>

    <div class="main-layout">
        <div id="btn-grid" class="btn-grid"></div>
        <div id="pad-area">TOUCHPAD</div>
    </div>

    <!-- Modals -->
    <div id="profile-modal" class="modal-outer">
        <div class="modal-content">
            <h3>Profile Settings</h3>
            <div class="input-group">
                <label>Grid Size</label>
                <select id="cfg-grid-size">
                    <option value="3">3 x 3 (9 Buttons)</option>
                    <option value="4">4 x 4 (16 Buttons)</option>
                    <option value="5">5 x 5 (25 Buttons)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeProfileConfig()">Cancel</button>
                <button class="modal-btn btn-cancel" onclick="v(); duplicateProfile()">Copy</button>
                <button class="modal-btn btn-delete" onclick="deleteCurrentProfile()">Delete</button>
                <button class="modal-btn btn-save" onclick="saveProfileConfig()">Save</button>
            </div>
        </div>
    </div>

    <div id="btn-modal" class="modal-outer">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Button</h3>
                <div class="modal-delete-btn" onclick="deleteCurrentButton()">Delete</div>
            </div>
            <div class="input-group">
                <label>Button Label</label>
                <input type="text" id="cfg-label" placeholder="e.g. Copy">
            </div>
            <div class="input-group">
                <label>
                    Emoji Icon
                    <a href="https://emojidb.org/" target="_blank"
                        style="color:#007AFF;text-decoration:none;font-size:10px;">Emoji DB ‚Üó</a>
                </label>
                <input type="text" id="cfg-emoji" placeholder="üöÄ">
            </div>
            <div class="input-group">
                <label>
                    Macro Keys (comma separated)
                    <a href="https://pynput.readthedocs.io/en/latest/keyboard.html#pynput.keyboard.Key" target="_blank"
                        style="color:#007AFF;text-decoration:none;font-size:10px;">Doc ‚Üó</a>
                </label>
                <input type="text" id="cfg-keys" placeholder="ctrl,c">
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeBtnConfig()">Cancel</button>
                <button class="modal-btn btn-save" onclick="saveBtnConfig()">Apply</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/sortablejs.js"></script>
    <script src="/static/js/touchpad.js"></script>
    <script>
        const socket = io();
        let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        const v = () => { if (navigator.vibrate) navigator.vibrate(25); };

        let editMode = false;
        let sortMode = false;
        let currentEditIndex = -1;
        let currentProfile = "Default";
        let sortInst = null;

        let macroData = {
            current: "Default",
            profiles: { "Default": { cols: 4, buttons: Array(16).fill(null).map(() => ({ label: "", emoji: "", keys: "" })) } }
        };

        // --- Data Sync ---
        socket.emit('load_macros');
        socket.on('macros_loaded', (data) => {
            if (data && data.profiles) {
                macroData = data;
                currentProfile = macroData.current || Object.keys(macroData.profiles)[0] || "Default";
            }
            updateProfileUI();
            renderButtons();
        });

        function saveToServer() { socket.emit('save_macros', macroData); }

        function updateProfileUI() {
            const select = document.getElementById('profile-select');
            select.innerHTML = '';
            Object.keys(macroData.profiles).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name;
                if (name === currentProfile) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function switchProfile(name) {
            currentProfile = name;
            macroData.current = name;
            saveToServer();
            renderButtons();
        }

        function addProfile() {
            const name = prompt("New Profile Name:");
            if (name && !macroData.profiles[name]) {
                macroData.profiles[name] = { cols: 4, buttons: Array(16).fill(null).map(() => ({ label: "", emoji: "", keys: "" })) };
                currentProfile = name;
                macroData.current = name;
                updateProfileUI(); saveToServer(); renderButtons();
            }
        }

        function duplicateProfile() {
            const newName = prompt(`Copy current profile "${currentProfile}" to:`);
            if (newName && !macroData.profiles[newName]) {
                // Ê∑±Êã∑Ë¥ùÂΩìÂâçÈÖçÁΩÆ
                macroData.profiles[newName] = JSON.parse(JSON.stringify(macroData.profiles[currentProfile]));
                currentProfile = newName;
                macroData.current = newName;
                updateProfileUI(); saveToServer(); renderButtons();
            } else if (newName) {
                alert("Profile name already exists!");
            }
        }

        // --- Render ---
        function renderButtons() {
            const grid = document.getElementById('btn-grid');
            grid.innerHTML = '';
            const profile = macroData.profiles[currentProfile];
            grid.style.setProperty('--cols', profile.cols);

            profile.buttons.forEach((cfg, i) => {
                const btn = document.createElement('div');
                btn.className = 'macro-btn';
                if (editMode) btn.classList.add('editing');
                if (sortMode) btn.classList.add('sorting');

                if (cfg.emoji) {
                    const em = document.createElement('div');
                    em.className = 'emoji'; em.innerText = cfg.emoji;
                    btn.appendChild(em);
                }
                if (cfg.label) {
                    const label = document.createElement('div');
                    label.className = 'label'; label.innerText = cfg.label;
                    btn.appendChild(label);
                }

                // Interactions
                if (!editMode && !sortMode) {
                    btn.onpointerdown = () => handleBtnDown(i);
                    btn.onpointerup = () => handleBtnUp(i);
                    btn.onpointercancel = () => handleBtnUp(i);
                } else if (editMode) {
                    btn.onclick = () => { v(); openBtnConfig(i); };
                }

                grid.appendChild(btn);
            });

            initSortable();
        }

        // --- Sorting ---
        function initSortable() {
            console.log("[Sort] Function called. sortMode is:", sortMode);
            const grid = document.getElementById('btn-grid');

            if (sortInst) {
                console.log("[Sort] Destroying existing instance");
                sortInst.destroy();
                sortInst = null;
            }

            if (!sortMode) {
                console.log("[Sort] Mode is OFF, stopping here.");
                return;
            }

            if (typeof Sortable === 'undefined') {
                console.error("[Sort] ERROR: Sortable library is NOT defined in global scope.");
                alert("ÊãñÊîæÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÊàñÊ£ÄÊü•ÁΩëÁªú„ÄÇ");
                return;
            }

            console.log("[Sort] Starting initialization on grid...", grid);

            try {
                sortInst = new Sortable(grid, {
                    animation: 200,
                    swap: true,
                    swapClass: 'sortable-swap-highlight',
                    ghostClass: 'sortable-ghost',
                    forceFallback: true,
                    onStart: function () { console.log("[Sort] Dragging started"); v(); },
                    onEnd: function (evt) {
                        console.log(`[Sort] Dragging ended: ${evt.oldIndex} -> ${evt.newIndex}`);
                        if (evt.oldIndex === undefined || evt.newIndex === undefined || evt.oldIndex === evt.newIndex) {
                            console.log("[Sort] No position change");
                            return;
                        }

                        const btns = macroData.profiles[currentProfile].buttons;
                        console.log("[Sort] Array Swap triggered");
                        const temp = btns[evt.oldIndex];
                        btns[evt.oldIndex] = btns[evt.newIndex];
                        btns[evt.newIndex] = temp;

                        saveToServer();
                        setTimeout(() => {
                            console.log("[Sort] UI Refresh triggered");
                            renderButtons();
                        }, 50);
                    }
                });
                console.log("[Sort] Sortable successfully initialized.");
            } catch (err) {
                console.error("[Sort] Exception during Sortable creation:", err);
            }
        }

        // --- Mode Toggles ---
        function toggleEditMode() {
            v();
            editMode = !editMode;
            if (editMode) sortMode = false;
            updateHeaderUI();
            renderButtons();
        }

        function toggleSortMode() {
            v();
            sortMode = !sortMode;
            if (sortMode) editMode = false;
            updateHeaderUI();
            renderButtons();
        }

        function updateHeaderUI() {
            document.getElementById('edit-toggle').classList.toggle('active', editMode);
            document.getElementById('sort-toggle').classList.toggle('active', sortMode);
        }

        // --- Handlers ---
        function handleBtnDown(i) {
            initAudio(); v();
            const cfg = macroData.profiles[currentProfile].buttons[i];
            if (cfg && cfg.keys) {
                cfg.keys.split(',').forEach(k => socket.emit('key_action', { key: k.trim().toLowerCase(), action: 'down' }));
            }
        }

        function handleBtnUp(i) {
            const cfg = macroData.profiles[currentProfile].buttons[i];
            if (cfg && cfg.keys) {
                cfg.keys.split(',').reverse().forEach(k => socket.emit('key_action', { key: k.trim().toLowerCase(), action: 'up' }));
            }
        }

        // --- Config ---
        function showProfileConfig() {
            document.getElementById('cfg-grid-size').value = macroData.profiles[currentProfile].cols;
            document.getElementById('profile-modal').style.display = 'flex';
        }
        function closeProfileConfig() { document.getElementById('profile-modal').style.display = 'none'; }

        function saveProfileConfig() {
            const newCols = parseInt(document.getElementById('cfg-grid-size').value);
            const profile = macroData.profiles[currentProfile];
            const target = newCols * newCols;
            if (profile.buttons.length > target && !confirm(`This will truncate extra buttons. OK?`)) return;

            profile.cols = newCols;
            if (profile.buttons.length < target) {
                while (profile.buttons.length < target) profile.buttons.push({ label: "", emoji: "", keys: "" });
            } else {
                profile.buttons = profile.buttons.slice(0, target);
            }
            saveToServer(); closeProfileConfig(); renderButtons();
        }

        function deleteCurrentProfile() {
            if (Object.keys(macroData.profiles).length <= 1) return;
            if (confirm(`Delete current profile?`)) {
                delete macroData.profiles[currentProfile];
                currentProfile = Object.keys(macroData.profiles)[0];
                macroData.current = currentProfile;
                updateProfileUI(); saveToServer(); closeProfileConfig(); renderButtons();
            }
        }

        function deleteCurrentButton() {
            if (confirm("Permanently clear this button's data?")) {
                macroData.profiles[currentProfile].buttons[currentEditIndex] = { label: "", emoji: "", keys: "" };
                saveToServer();
                closeBtnConfig();
                renderButtons();
            }
        }

        function openBtnConfig(i) {
            currentEditIndex = i;
            const cfg = macroData.profiles[currentProfile].buttons[i];
            document.getElementById('cfg-label').value = cfg.label || '';
            document.getElementById('cfg-emoji').value = cfg.emoji || '';
            document.getElementById('cfg-keys').value = cfg.keys || '';
            document.getElementById('btn-modal').style.display = 'flex';
        }
        function closeBtnConfig() { document.getElementById('btn-modal').style.display = 'none'; }
        function saveBtnConfig() {
            macroData.profiles[currentProfile].buttons[currentEditIndex] = {
                label: document.getElementById('cfg-label').value.trim(),
                emoji: document.getElementById('cfg-emoji').value.trim(),
                keys: document.getElementById('cfg-keys').value.trim()
            };
            saveToServer(); closeBtnConfig(); renderButtons();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        const touchpad = new TouchpadModule('pad-area', socket, {
            getSensitivity: () => parseFloat(localStorage.getItem('mouse_sense')) || 4.0,
            feedback: v
        });
    </script>
</body>

</html>